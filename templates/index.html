<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nourish Net</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://kit.fontawesome.com/e1edd9a381.js" crossorigin="anonymous"></script>
</head>

<body>

    <!-- Authentication Container (login/register) -->
    <div class="auth-container" id="authContainer">
        <!-- Registration Page -->
        <div class="register" id="registerPage">
            <h3>Registration</h3>
            <form class="register_page" onsubmit="registerUser(event)">
                <div class="form-group">
                    <i class="fa-solid fa-user icon"></i>
                    <input type="text" name="fullname" placeholder="Full name" required>
                </div>

                <div class="form-group">
                    <i class="fa-solid fa-envelope icon"></i>
                    <input type="email" name="email" placeholder="Email" required>
                </div>

                <div class="form-group">
                    <i class="fa-solid fa-phone icon"></i>
                    <input type="text" name="contact" id="phoneInput" placeholder="Phone number" required>
                </div>

                <div class="form-group">
                    <i class="fa-solid fa-lock icon"></i>
                    <input type="password" name="password" id="registerPwd" placeholder="Password" required>
                </div>

                <input type="checkbox" onclick="registerPassword()"> Show Password

                <button type="submit" class="btn">Register</button>

                <p>Already have an account? <span onclick="showLogin()">Login</span></p>
            </form>
        </div>

        <!-- Login Page -->
        <div class="login hidden" id="loginPage">
            <h3>Login</h3>
            <form class="login_page" onsubmit="loginUser(event)">
                <div class="form-group">
                    <i class="fa-solid fa-phone icon"></i>
                    <input type="text" name="contact" id="loginPhoneInput" placeholder="Phone number" required>
                </div>

                <div class="form-group">
                    <i class="fa-solid fa-lock icon"></i>
                    <input type="password" name="password" id="loginPwd" placeholder="Password" required>
                </div>

                <input type="checkbox" onclick="loginPassword()"> Show Password

                <button type="submit" class="btn">Login</button>
                <p>Don't have an account? <span onclick="showRegister()">Register</span></p>
            </form>
        </div>
    </div>

    <!-- Main Application Container -->
    <div class="app-container hidden" id="appContainer">

        <!-- Navigation Bar -->
        <nav>
            <div class="nav-bar">
                <i class="fa-solid fa-bars sidebarOpen"></i>
                <h3 class="logo navLogo">Nourish Net</h3>

                <!-- Replace the user-info div with this -->
                <div class="user-dropdown">
                    <div class="dropdown-toggle" id="userDropdown">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <div class="dropdown-menu hidden" id="userMenu">
                        <div class="dropdown-header">
                            <i class="fa-solid fa-user-circle"></i>
                            <span id="usernameDisplay"></span>
                        </div>
                        <div class="dropdown-divider"></div>
                        <a href="#" onclick="showProfilePage()" class="dropdown-item">
                            <i class="fa-solid fa-user-pen"></i> Profile
                        </a>
                        <a href="#" onclick="logout()" class="dropdown-item">
                            <i class="fa-solid fa-right-from-bracket"></i> Logout
                        </a>
                    </div>
                </div>

                <div class="menu">
                    <div class="logo-toggle">
                        <h3>Nourish Net</h3>
                        <i class="fa-regular fa-x sidebarClose"></i>
                    </div>
                    <ul class="nav-links">
                        <li><a href="#" onclick="showPage('home')" class="active">Home</a></li>
                        <li><a href="#" onclick="showPage('categories')">Categories</a></li>
                        <li><a href="#" onclick="showPage('menu')">Menu</a></li>
                        <li><a href="#" onclick="showPage('orders')">Orders</a></li>
                        <li><a href="#" onclick="showProfilePage()">Profile</a></li>
                        <li><a href="/admin" class="admin-link" style="display: none;">
                                <i class="fa-solid fa-lock"></i> Admin
                            </a>
                        </li>
                        <li><a href="#" onclick="logout()">Logout</a></li>
                    </ul>
                </div>

                <div class="searchBox">
                    <div class="searchToggle">
                        <i class="fa-regular fa-x cancel"></i>
                        <i class="fa-solid fa-magnifying-glass search"></i>
                    </div>

                    <div class="search-field">
                        <input type="text" placeholder="Search food...">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Page Sections -->
        <div id="home" class="page-section active">
            <div class="hero">
                <h1>Welcome to Nourish Net</h1>
                <p>Delicious meals delivered to your doorstep</p>
            </div>
        </div>

        <!-- Profile page -->
        <div id="profile" class="page-section">
            <h2>My Profile</h2>
            <div class="profile-container">
                <div class="profile-header">
                    <i class="fa-solid fa-user-circle"></i>
                    <h3 id="profileUsername"></h3>
                </div>
                <div class="profile-details">
                    <div class="detail-item">
                        <label><i class="fa-solid fa-envelope"></i> Email:</label>
                        <span id="profileEmail"></span>
                    </div>
                    <div class="detail-item">
                        <label><i class="fa-solid fa-phone"></i> Phone:</label>
                        <span id="profilePhone"></span>
                    </div>
                </div>
                <button class="btn" onclick="showPage('home')">Back to Home</button>
            </div>
        </div>

        <!-- Categories page -->
        <div id="categories" class="page-section">
            <div class="categories-grid" id="categoriesGrid">
                <!-- Categories will be populated by JavaScript -->
            </div>
        </div>

        <!-- Menu Page -->
        <div id="menu" class="page-section">
            <h2>Menu</h2>
            <div class="menu-container">
                <!-- Cart Summary -->
                <div class="cart-summary" id="cartSummary" style="display: none;">
                    <h4>Your Order</h4>
                    <div id="cartItems"></div>
                    <div class="cart-total" id="cartTotal">TOTAL: KSh 0</div>
                    <div class="cart-actions">
                        <button class="checkout-btn" onclick="initiatePayment()">Checkout (KSh <span
                                id="checkoutTotal">0</span>)</button>
                        <button class="clear-btn" onclick="clearCart()">Clear Cart</button>
                    </div>
                </div>

                <div class="menu-grid" id="menuGrid">
                    <!-- Menu items will be populated by JavaScript -->
                </div>
            </div>

        </div>

        <!-- Orders page -->
        <div id="orders" class="page-section">
            <h2 class="section-title">My Orders</h2>

            <div class="order-filters">
                <button class="filter-btn active" onclick="filterOrders('all')">All Orders</button>
                <button class="filter-btn" onclick="filterOrders('pending')">Pending</button>
                <button class="filter-btn" onclick="filterOrders('completed')">Completed</button>
                <button class="filter-btn" onclick="filterOrders('cancelled')">Cancelled</button>
            </div>

            <div class="orders-grid" id="ordersGrid">
                <!-- Orders will be populated by JavaScript -->
            </div>
        </div>

    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal hidden">
        <div class="modal-content">
            <h3>MPESA Payment</h3>
            <p>Enter your phone number to receive STK Push</p>
            <input type="tel" name="contact" id="phoneNumber" placeholder="254712345678">
            <div class="modal-actions">
                <button class="payment-btn" onclick="processPayment()">Pay Now</button>
                <button class="payment-btn cancel-btn" onclick="closePaymentModal()"
                    style="background: #cc1414; color: black;">Cancel</button>
            </div>

            <div id="paymentStatus" style="margin-top: 16px;"></div>
        </div>
    </div>

    <script>
        // Cart and orders storage
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let orders = JSON.parse(localStorage.getItem('orders')) || [];
        let currentFilter = 'all';
        let currentCategoryFilter = null;
        let currentOrderId = null

        // DOM Elements
        const body = document.querySelector("body"),
            nav = document.querySelector("nav"),
            searchToggle = document.querySelector(".searchToggle"),
            sidebarOpen = document.querySelector(".sidebarOpen"),
            sidebarClose = document.querySelector(".sidebarClose"),
            authContainer = document.getElementById("authContainer"),
            appContainer = document.getElementById("appContainer"),
            phoneNumber = document.getElementById("phoneNumber"),
            phoneInput = document.getElementById("phoneInput"),
            loginPhoneInput = document.getElementById("loginPhoneInput");

        // js code to toggle search box
        searchToggle.addEventListener("click", () => {
            searchToggle.classList.toggle("active");
        });


        //   js code to toggle sidebar
        sidebarOpen.addEventListener("click", () => {
            nav.classList.add("active");
        });

        body.addEventListener("click", e => {
            let clickedElm = e.target;
            if (!clickedElm.classList.contains("sidebarOpen") && !clickedElm.classList.contains("menu")) {
                nav.classList.remove("active");
            }
        });

        // ========== AUTHENTICATION FUNCTIONS ==========
        // function showLogin() {
        //     document.getElementById("registerPage").classList.add('hidden');
        //     document.getElementById("loginPage").classList.remove('hidden');
        //     // document.querySelector('.login_page').reset();
        // }

        // function showRegister() {
        //     document.getElementById("loginPage").classList.add('hidden');
        //     document.getElementById("registerPage").classList.remove('hidden');
        //     // document.querySelector('.register_page').reset();
        // }

        function showLogin() {
            document.getElementById("registerPage").classList.add('hidden');
            document.getElementById("loginPage").classList.remove('hidden');
            // document.title = "Login | Nourish Net";
            history.replaceState({ pageId: 'login' }, '', '/login');
        }

        function showRegister() {
            document.getElementById("loginPage").classList.add('hidden');
            document.getElementById("registerPage").classList.remove('hidden');
            // document.title = "Register | Nourish Net";
            history.replaceState({ pageId: 'register' }, '', '/register');
        }


        // Registration handler
        async function registerUser(event) {
            event.preventDefault();
            const form = event.target;
            const formData = {
                fullname: form.fullname.value,
                email: form.email.value,
                contact: form.contact.value,
                password: form.password.value
            };

            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    // Switch to app view on successful registration
                    authContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    showLogin();
                } else {
                    alert('Registration failed: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Registration failed. Please try again.');
            }
        }

        // Login handler
        // Login handler
        async function loginUser(event) {
            event.preventDefault();
            const form = event.target;
            const formData = {
                contact: form.contact.value,
                password: form.password.value
            };

            const submitBtn = form.querySelector('button[type="submit"]');

            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa-solid fa-spinner"></i> Logging in...';

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (!response.ok) {
                    // Handle HTTP errors (4xx, 5xx)
                    throw new Error(data.message || 'Login failed');
                }

                if (data.success) {
                    handleLoginSuccess(data.user);
                } else {
                    // Show error message from server
                    alert('Login failed: ' + data.message);
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login error: ' + error.message);
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.textContent = 'Login';
            }
        }

        function setupUserDropdown() {
            const dropdownToggle = document.getElementById('userDropdown');
            const dropdownMenu = document.getElementById('userMenu');

            // Toggle dropdown on click
            dropdownToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdownMenu.classList.toggle('hidden');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!dropdownMenu.contains(e.target) && !dropdownToggle.contains(e.target)) {
                    dropdownMenu.classList.add('hidden');
                }
            });
        }

        function updateUserDropdown(user) {
            const usernameDisplay = document.getElementById('usernameDisplay');
            if (user && user.fullname) {
                usernameDisplay.textContent = user.fullname;
                document.getElementById('userDropdown').classList.remove('hidden');
            } else {
                document.getElementById('userDropdown').classList.add('hidden');
                document.getElementById('userMenu').classList.add('hidden');
            }
        }


        // Logout function - shows auth container
        function logout() {
            fetch('/api/logout', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        localStorage.removeItem('user');
                        sessionStorage.removeItem('currentPage');

                        appContainer.classList.add('hidden');
                        authContainer.classList.remove('hidden');
                        showLogin();
                        history.replaceState({ pageId: 'login' }, '', '/login');
                    } else {
                        alert('Logout failed. Try again.');
                    }
                })
                .catch(err => {
                    console.error('Logout error:', err);
                    alert('Logout error: ' + err.message);
                });
        }


        function registerPassword() {
            const x = document.getElementById("registerPwd");
            x.type = x.type === "password" ? "text" : "password";
        }

        function loginPassword() {
            const x = document.getElementById("loginPwd");
            x.type = x.type === "password" ? "text" : "password";
        }

        // Login success handler
        function handleLoginSuccess(userData) {
            localStorage.setItem('user', JSON.stringify(userData));
            updateUserDropdown(userData);

            authContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');

            showPage('home');
            history.replaceState({ pageId: 'home' }, '', '/home');

        }

        // ========== APPLICATION FUNCTIONS ==========
        // Navigation functions
        function showPage(pageId) {
            // Store current page in sessionStorage
            sessionStorage.setItem('currentPage', pageId);

            // Hide all pages
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active')
            });

            // Show selected page
            document.getElementById(pageId).classList.add('active');

            // Update navigation
            document.querySelectorAll('.nav-links a').forEach(link => {
                link.classList.remove('active')
            });

            // Find and activate the current link
            const currentLink = document.querySelector(`.nav-links a[onclick*="${pageId}"]`);
            if (currentLink) {
                currentLink.classList.add('active');
            }

            // Push URL and save page
            history.pushState({ pageId }, '', `/${pageId}`);
            sessionStorage.setItem('currentPage', pageId);

            // load page-specific content
            if (pageId === 'menu') {
                if (!currentCategoryFilter) {
                    loadMenu();
                }
                initCart(); // Initialize the cart display
            } else if (pageId === 'orders') {
                loadOrders();
            } else if (pageId === 'categories') {
                loadCategories();
            }
        }

        window.onpopstate = function (event) {
            const pageId = event.state?.pageId || location.pathname.replace('/', '') || 'home';
            showPage(pageId);
        };


        // Profile page function
        function showProfilePage() {
            const user = JSON.parse(localStorage.getItem('user'));
            if (user) {
                document.getElementById('profileUsername').textContent = user.fullname;
                document.getElementById('profileEmail').textContent = user.email;
                document.getElementById('profilePhone').textContent = user.contact;
            }
            document.getElementById('userMenu').classList.add('hidden');
            showPage('profile');
        }

        // Category functions
        function loadCategories() {
            fetch('/api/categories')
                .then(response => response.json())
                .then(categories => {
                    const categoriesGrid = document.getElementById('categoriesGrid');
                    categoriesGrid.innerHTML = categories.map(category => `
                        <div class="category-card" style="padding: 20px; margin: 10px; border: 1px solid #ddd; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.2s;" onclick="showCategoryMenu(${category.id}, '${category.name}')">
                            ${category.image_url ? `<img src="${category.image_url}" alt="${category.name}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 4px; margin-bottom: 10px;">` : ''}
                            <h3 style="margin: 10px 0; color: #333;">${category.name}</h3>
                            ${category.description ? `<p style="color: #666; margin-bottom: 15px;">${category.description}</p>` : ''}
                            <button style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">View Menu</button>
                        </div>
            `).join('');
                })
                .catch(error => {
                    console.error('Error loading categories:', error);
                    document.getElementById('categoriesGrid').innerHTML = '<p>Error loading categories</p>';
                });
        }

        function showCategoryMenu(categoryId, categoryName) {
            currentCategoryFilter = categoryId;
            fetch(`/api/menu/category/${categoryId}`)
                .then(response => response.json())
                .then(items => {
                    const menuGrid = document.getElementById('menuGrid');

                    // Add a back button and category title
                    menuGrid.innerHTML = `
                <div class="category-header">
                    <button onclick="loadMenu(); currentCategoryFilter = null;">
                        ← Back
                    </button>
                </div>
                <h2 style="margin: 0;">${categoryName}</h2>
                <div class="category-items-grid">
                    ${items.map(item => `
                        <div class="menu-item">
                            <img src="${item.image_url || 'https://via.placeholder.com/300x200?text=No+Image'}" 
                                 alt="${item.name}" 
                                 onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                            <div class="menu-item-content">
                                <h3>${item.name}</h3>
                                <p>${item.description || 'No description available'}</p>
                                <div class="menu-item-footer">
                                    <span class="price">KSh ${item.price.toFixed(2)}</span>
                                    <button class="add-to-cart" onclick="addToCart(${item.id})">Add to Cart</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

                    // Show the menu page
                    showPage('menu');
                })
                .catch(error => {
                    console.error('Error loading category menu:', error);
                    document.getElementById('menuGrid').innerHTML = '<p>Error loading menu items</p>';
                });
        }

        // Menu functions
        async function loadMenu() {
            try {
                // Fetch categories and menu items
                const categoriesResponse = await fetch('/api/categories');
                const menuItemsResponse = await fetch('/api/menu');

                if (!categoriesResponse.ok || !menuItemsResponse.ok) {
                    throw new Error('Failed to load menu data');
                }

                const categories = await categoriesResponse.json();
                const allMenuItems = await menuItemsResponse.json();
                const menuGrid = document.getElementById('menuGrid');

                // Clear existing content
                menuGrid.innerHTML = '';

                if (allMenuItems.length === 0) {
                    menuGrid.innerHTML = '<p>No menu items available</p>';
                    return;
                }

                // Group menu items by category
                const menuByCategory = {};
                allMenuItems.forEach(item => {
                    if (!menuByCategory[item.category_id]) {
                        menuByCategory[item.category_id] = [];
                    }
                    menuByCategory[item.category_id].push(item);
                });

                // Create sections for each category that has items
                categories.forEach(category => {
                    const categoryItems = menuByCategory[category.id];
                    if (categoryItems && categoryItems.length > 0) {
                        const categorySection = document.createElement('div');
                        categorySection.className = 'menu-category-section';
                        categorySection.innerHTML = `
                    <h3 class="category-title">${category.name}</h3>
                    <div class="category-items-grid" id="category-${category.id}"></div>
                `;
                        menuGrid.appendChild(categorySection);

                        const categoryContainer = document.getElementById(`category-${category.id}`);
                        categoryItems.forEach(item => {
                            const itemElement = document.createElement('div');
                            itemElement.className = 'menu-item';
                            itemElement.innerHTML = `
                        <img src="${item.image_url || 'https://via.placeholder.com/300x200?text=No+Image'}" 
                             alt="${item.name}" 
                             onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                        <div class="menu-item-content">
                            <h3>${item.name}</h3>
                            <p>${item.description || 'No description available'}</p>
                            <div class="menu-item-footer">
                                <span class="price">KSh ${item.price.toFixed(2)}</span>
                                <button class="add-to-cart" onclick="addToCart(${item.id})">Add to Cart</button>
                            </div>
                        </div>
                    `;
                            categoryContainer.appendChild(itemElement);
                        });
                    }
                });

            } catch (error) {
                console.error('Error loading menu:', error);
                document.getElementById('menuGrid').innerHTML = `
            <div class="error-message">
                <p>Error loading menu items. Please try again later.</p>
            </div>
        `;
            }
        }

        // Add to cart function
        async function addToCart(itemId) {
            try {
                // Check if we're on the menu page
                const cartItemsEl = document.getElementById('cartItems');
                if (!cartItemsEl) {
                    console.warn('Cart elements not found - are you on the menu page?');
                    return;
                }

                const response = await fetch(`/api/menu/${itemId}`);
                if (!response.ok) throw new Error('Failed to fetch item');

                const data = await response.json();
                if (!data.success) throw new Error(data.message || 'Item not found');

                const item = data.item;
                const existingItem = cart.find(i => i.id === item.id);

                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    cart.push({
                        id: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: 1
                    });
                }

                // Save to localStorage
                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartDisplay();

            } catch (error) {
                console.error('Error adding to cart:', error);
                alert(`Couldn't add item to cart: ${error.message}`);
            }
        }

        // Update cart display function
        function updateCartDisplay() {
            const cartSummary = document.getElementById('cartSummary');
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');

            // Check if elements exist (we might not be on the menu page)
            if (!cartSummary || !cartItems || !cartTotal) {
                return;
            }

            if (cart.length === 0) {
                cartSummary.style.display = 'none';
                return;
            }

            cartSummary.style.display = 'block';

            // Clear previous items
            cartItems.innerHTML = '';

            // Add current items
            cart.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'cart-item';
                itemElement.innerHTML = `
            <span>${item.name} x${item.quantity}</span>
            <span>KSh ${(item.price * item.quantity).toFixed(2)}</span>
            <button onclick="removeFromCart(${item.id})" class="remove-btn">×</button>
        `;
                cartItems.appendChild(itemElement);
            });

            // Update the checkout total display
            const checkoutTotal = document.getElementById('checkoutTotal');
            if (checkoutTotal) {
                const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                checkoutTotal.textContent = total.toFixed(2);
            }

            // Calculate and display total
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            cartTotal.textContent = `TOTAL: KSh ${total.toFixed(2)}`;
        }

        // Call this when the menu page loads
        function initCart() {
            updateCartDisplay();
        }

        // Add remove from cart function
        function removeFromCart(itemId) {
            cart = cart.filter(item => item.id !== itemId);
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartDisplay();
        }

        // Add clear cart function
        function clearCart() {
            cart = [];
            localStorage.removeItem('cart');
            updateCartDisplay();
        }

        // Utility function to safely get element
        function getElement(id) {
            const el = document.getElementById(id);
            if (!el) {
                console.warn(`Element with ID ${id} not found`);
            }
            return el;
        }

        // Safe version of updateCartDisplay
        function safeUpdateCartDisplay() {
            try {
                updateCartDisplay();
            } catch (error) {
                console.error('Error updating cart display:', error);
            }
        }


        // Phone number formatting and validation
        function formatPhoneNumber(phone) {
            // Remove any non-digit characters
            phone = phone.replace(/\D/g, '');

            // Handle different formats
            if (phone.startsWith('254') && phone.length === 12) {
                return phone; // Already in correct format
            } else if (phone.startsWith('0') && phone.length === 10) {
                return '254' + phone.slice(1); // Convert 07... or 01... to 2547... or 2541...
            } else if ((phone.startsWith('7') || phone.startsWith('1')) && phone.length === 9) {
                return '254' + phone; // Convert 7... or 1... to 2547... or 2541...
            } else if (phone.startsWith('+254') && phone.length === 13) {
                return phone.slice(1); // Remove the +
            }

            // If none of the above, return as is (will fail validation)
            return phone;
        }

        function validatePhone(phone) {
            const regex = /^(?:254|0)?(7|1)\d{8}$/;
            return regex.test(phone);
        }

        // Real-time phone number formatting
        if (phoneInput) {
            phoneInput.addEventListener('input', function (e) {
                let formattedNumber = formatPhoneNumber(e.target.value);
                e.target.value = formattedNumber;
            });
        }

        if (loginPhoneInput) {
            loginPhoneInput.addEventListener('input', function (e) {
                let formattedNumber = formatPhoneNumber(e.target.value);
                e.target.value = formattedNumber;
            });
        }

        if (phoneNumber) {
            phoneNumber.addEventListener('input', function (e) {
                let formattedNumber = formatPhoneNumber(e.target.value);
                e.target.value = formattedNumber;
            });
        }

        // Payment functions
        function initiatePayment() {
            if (cart.length === 0) {
                alert('Your cart is empty');
                return;
            }

            const paymentModal = document.getElementById('paymentModal');
            paymentModal.classList.remove('hidden');

            // Add "Save as Pending" button
            const modalActions = document.querySelector('.modal-actions');
            if (!modalActions.querySelector('.save-pending-btn')) {
                const savePendingBtn = document.createElement('button');
                savePendingBtn.className = 'payment-btn save-pending-btn';
                savePendingBtn.textContent = 'Save as Pending';
                savePendingBtn.onclick = saveOrderAsPending;
                savePendingBtn.style.background = '#f39c12';
                modalActions.insertBefore(savePendingBtn, modalActions.firstChild);
            }
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
            document.getElementById('paymentStatus').innerHTML = '';
        }

        // Add event listener for the close button
        document.querySelector('.close-paymodal').addEventListener('click', closePaymentModal);


        async function saveOrderAsPending() {
            const phoneNumber = document.getElementById('phoneNumber').value;
            const paymentStatus = document.getElementById('paymentStatus');

            if (!phoneNumber || !phoneNumber.startsWith('254')) {
                paymentStatus.textContent = 'Please enter a valid Kenyan phone number (starts with 254)';
                paymentStatus.style.color = 'red';
                return;
            }

            try {
                paymentStatus.textContent = 'Saving order...';
                paymentStatus.style.color = 'blue';

                // Calculate total
                const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

                // Create pending order
                const orderId = await createOrder(phoneNumber, total, 'pending');

                paymentStatus.textContent = 'Order saved as pending! Order #' + orderId;
                paymentStatus.style.color = 'orange';

                // Don't clear cart - user might want to modify it later
                updateCartDisplay();

                // Close modal after 3 seconds
                setTimeout(() => {
                    closePaymentModal();
                    showPage('orders');
                }, 3000);

            } catch (error) {
                console.error('Error saving order:', error);
                paymentStatus.textContent = 'Error saving order: ' + error.message;
                paymentStatus.style.color = 'red';
            }
        }

        async function processPayment() {
            const phoneNumber = document.getElementById('phoneNumber').value;
            const paymentStatus = document.getElementById('paymentStatus');
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            if (!phoneNumber || !validatePhone(phoneNumber)) {
                paymentStatus.textContent = 'Please enter a valid Kenyan phone number (e.g. 07... or 01...)';
                paymentStatus.style.color = 'red';
                return;
            }

            try {
                paymentStatus.innerHTML = `
            <div style="color: #f39c12;">
                <p>📱 STK Push sent to ${phoneNumber}</p>
                <p>Please enter your MPESA PIN...</p>
            </div>
        `;

                // Create order first
                const orderId = await createOrder(phoneNumber, total, 'pending');

                // Call your backend to initiate M-Pesa payment
                const response = await fetch('/api/make-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone: phoneNumber,
                        amount: total,
                        order_id: orderId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    paymentStatus.innerHTML = `
                <div style="color: #27ae60;">
                    <p>✅ Payment initiated successfully!</p>
                    <p>${data.responseDescription || 'Waiting for payment confirmation...'}</p>
                </div>
            `;

                    // Start polling for payment status (optional)
                    pollPaymentStatus(data.checkoutRequestId, orderId);
                } else {
                    paymentStatus.innerHTML = `
                <div style="color: #e74c3c;">
                    <p>❌ Payment Failed</p>
                    <p>${data.error || 'Please try again'}</p>
                </div>
            `;
                }
            } catch (error) {
                console.error('Payment error:', error);
                paymentStatus.textContent = 'Payment failed: ' + error.message;
                paymentStatus.style.color = 'red';
            }
        }

        // Optional: Function to poll payment status
        async function pollPaymentStatus(checkoutRequestId, orderId) {
            try {
                const response = await fetch('/api/query-payment-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        checkout_request_id: checkoutRequestId
                    })
                });

                const data = await response.json();

                if (data.ResultCode === "0") {
                    // Payment successful
                    updateOrderStatus(orderId, 'completed');
                    // Clear cart
                    cart = [];
                    localStorage.removeItem('cart');
                    updateCartDisplay();

                    // Close modal after 3 seconds and show orders
                    setTimeout(() => {
                        closePaymentModal();
                        showPage('orders');
                    }, 3000);
                } else if (data.ResultCode === "1032") {
                    // Payment still pending - poll again after delay
                    setTimeout(() => pollPaymentStatus(checkoutRequestId, orderId), 5000);
                } else {
                    // Payment failed
                    updateOrderStatus(orderId, 'failed');
                }
            } catch (error) {
                console.error('Error polling payment status:', error);
            }
        }

        async function updateOrderStatus(orderId, status) {
            try {
                const response = await fetch(`/api/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: status })
                });

                const data = await response.json();
                if (data.success) {
                    // Update local orders
                    const orders = JSON.parse(localStorage.getItem('orders')) || [];
                    const orderIndex = orders.findIndex(o => o.id === orderId);
                    if (orderIndex !== -1) {
                        orders[orderIndex].status = status;
                        localStorage.setItem('orders', JSON.stringify(orders));
                    }
                }
            } catch (error) {
                console.error('Error updating order status:', error);
            }
        }

        // Helper function to create an order in the database
        async function createOrder(phoneNumber, total, status) {
            try {
                const user = JSON.parse(localStorage.getItem('user'));
                const userId = user ? user.id : null;

                const orderData = {
                    order_id: currentOrderId, // Include this when updating
                    user_id: userId,
                    items: cart.map(item => ({
                        menu_item_id: item.id,
                        quantity: item.quantity,
                        unit_price: item.price,
                        subtotal: item.price * item.quantity
                    })),
                    total_amount: total,
                    customer_phone: phoneNumber,
                    status: status,
                    payment_status: status === 'completed' ? 'completed' : 'pending'
                };

                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to create/update order');
                }

                // Update local orders array
                let orders = JSON.parse(localStorage.getItem('orders')) || [];

                if (currentOrderId) {
                    // Update existing order in local storage
                    const orderIndex = orders.findIndex(o => o.id === currentOrderId);
                    if (orderIndex !== -1) {
                        orders[orderIndex] = {
                            ...orders[orderIndex],
                            items: cart.map(item => ({
                                id: item.id,
                                name: item.name,
                                price: item.price,
                                quantity: item.quantity
                            })),
                            total: total,
                            status: status,
                            payment_status: status === 'completed' ? 'completed' : 'pending'
                        };
                    }
                } else {
                    // Add new order to local storage
                    const newOrder = {
                        id: data.order_id,
                        items: cart.map(item => ({
                            id: item.id,
                            name: item.name,
                            price: item.price,
                            quantity: item.quantity
                        })),
                        total: total,
                        phone: phoneNumber,
                        status: status,
                        payment_status: status === 'completed' ? 'completed' : 'pending',
                        date: new Date().toLocaleDateString(),
                        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    };
                    orders.unshift(newOrder);
                }

                localStorage.setItem('orders', JSON.stringify(orders));
                return data.order_id || currentOrderId;
            } catch (error) {
                console.error('Error creating order:', error);
                throw error;
            } finally {
                currentOrderId = null; // Reset after operation
            }
        }

        // Orders functions
        function loadOrders() {
            filterOrders(currentFilter);
        }

        function filterOrders(status) {
            currentFilter = status;

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event?.target?.classList.add('active') || document.querySelector(`[onclick="filterOrders('${status}')"]`).classList.add('active');

            // Filter and display orders
            const filteredOrders = status === 'all' ? orders : orders.filter(order => order.status === status);

            const ordersGrid = document.getElementById('ordersGrid');

            if (filteredOrders.length === 0) {
                ordersGrid.innerHTML = `
                    <div class = "order-card">
                        <p style = "text-align = center; color: #7f8c8d;">No ${status === 'all' ? '' : status} orders found</p>
                    </div>
                
                `;
                return;
            }

            ordersGrid.innerHTML = filteredOrders.map(order => `
    <div class="order-card ${order.status}">
        <div class="order-header">
            <h4>Order #${order.id}</h4>
            <span class="order-status status-${order.status}">${order.status.toUpperCase()}</span>
        </div>
        <p><strong>Date:</strong> ${order.date} at ${order.time}</p>
        <p><strong>Phone:</strong> ${order.phone}</p>
        <p><strong>Items:</strong></p>
        <ul style="margin-left: 1rem;">
            ${order.items.map(item => `<li>${item.name} x${item.quantity} - KSh ${item.price * item.quantity}</li>`).join('')}
        </ul>
        <p><strong>Total: KSh ${order.total}</strong></p>
        <div class="order-actions">
            ${order.status === 'pending' ? `
                <button class="pay-btn" onclick="payOrder(${order.id})">Pay Now</button>
                <button class="cancel-order-btn" onclick="cancelOrder(${order.id})">Cancel Order</button>
            ` : ''}
            ${order.status === 'failed' ? `
                <button class="retry-btn" onclick="retryOrder(${order.id})">Retry Payment</button>
            ` : ''}
            <button class="delete-btn" onclick="confirmDelete(${order.id})">Delete</button>
        </div>
    </div>
`
            ).join('');

        }

        function confirmDelete(orderId) {
            if (confirm('Are you sure you want to permanently delete this order?')) {
                deleteOrder(orderId);
            }
        }

        function deleteOrder(orderId) {
            orders = orders.filter(order => order.id !== orderId);
            localStorage.setItem('orders', JSON.stringify(orders));
            filterOrders(currentFilter);
        }

        function payOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                currentOrderId = orderId; // Track the order we're paying
                cart = [...order.items];
                updateCartDisplay();
                showPage('menu');
                initiatePayment();
            }
        }

        async function cancelOrder(orderId) {
            if (confirm('Are you sure you want to cancel this order?')) {
                try {
                    const response = await fetch(`/api/orders/${orderId}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ status: 'cancelled' })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Update local orders
                        const orderIndex = orders.findIndex(o => o.id === orderId);
                        if (orderIndex !== -1) {
                            orders[orderIndex].status = 'cancelled';
                            localStorage.setItem('orders', JSON.stringify(orders));
                            filterOrders(currentFilter);
                        }
                    } else {
                        alert('Failed to cancel order: ' + data.message);
                    }
                } catch (error) {
                    console.error('Error cancelling order:', error);
                    alert('Error cancelling order. Please try again.');
                }
            }
        }

        async function retryOrder(orderId) {
            try {
                const order = orders.find(o => o.id === orderId);
                if (!order) {
                    throw new Error('Order not found');
                }

                // Set cart to the failed order items
                cart = order.items.map(item => ({
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity
                }));
                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartDisplay();

                // Show the menu page with the cart loaded
                showPage('menu');

                // Open payment modal with the phone number pre-filled
                document.getElementById('phoneNumber').value = order.phone;
                initiatePayment();
            } catch (error) {
                console.error('Error retrying order:', error);
                alert('Error loading order for retry: ' + error.message);
            }
        }

        function getExistingOrderId() {
            const id = currentOrderId;
            currentOrderId = null; // Clear after getting it
            return id;
        }



        // Secret admin activation (triple-click logo)
        document.querySelector('.logo').addEventListener('click', function (e) {
            if (e.detail === 3) { // Triple-click
                const password = prompt("Enter admin password:");
                if (password === "admin123") { // Change this!
                    localStorage.setItem('isAdmin', 'true');
                    document.querySelector('.admin-link').style.display = 'block';
                    alert("Admin mode activated");
                }
            }
        });

        // Initialize the app
        document.addEventListener('DOMContentLoaded', async function () {
            setupUserDropdown();

            const path = location.pathname.replace('/', '') || 'home';

            try {
                const res = await fetch('/api/check-session');
                const data = await res.json();

                if (data.valid) {
                    // Logged in
                    localStorage.setItem('user', JSON.stringify(data.user));
                    updateUserDropdown(data.user);

                    authContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');

                    if (['login', 'register'].includes(path)) {
                        showPage('home');
                        history.replaceState({ pageId: 'home' }, '', '/home');
                    } else {
                        showPage(path);
                        history.replaceState({ pageId: path }, '', `/${path}`);
                    }

                } else {
                    // Not logged in
                    localStorage.removeItem('user');
                    appContainer.classList.add('hidden');
                    authContainer.classList.remove('hidden');

                    if (path === 'register') {
                        showRegister();
                    } else {
                        showLogin();
                    }

                    history.replaceState({ pageId: path }, '', `/${path}`);
                }
            } catch (err) {
                console.error('Error checking session:', err);
                showLogin();
                history.replaceState({ pageId: 'login' }, '', '/login');
            }

            loadMenu();
            loadCategories();
            document.getElementById('paymentModal')?.classList.remove('active');
        });



        // Check for existing admin session on load
        document.addEventListener('DOMContentLoaded', function () {
            if (localStorage.getItem('isAdmin')) {
                document.querySelector('.admin-link').style.display = 'block';
            }
        });

    </script>
</body>

</html>